server {
    # 监听 Koyeb 的入口端口
    listen 8080 default_server;
    
    # 0. DeepSeek 健康检查端点
    location /ds_status {
        # 直接检查 DeepSeek 服务根路径
        proxy_pass http://127.0.0.1:5001/;
        proxy_method HEAD;
        proxy_set_header Host $host;
        
        # 快速超时设置
        proxy_connect_timeout 2s;
        proxy_read_timeout 2s;
        proxy_send_timeout 2s;
        
        # 拦截错误，返回自定义状态码
        proxy_intercept_errors on;
        
        # 如果 DeepSeek 返回 2xx/3xx，返回 200
        error_page 200 201 202 203 204 205 206 207 208 226 
                   301 302 303 304 305 306 307 308 =200 @ds_ok;
        
        # 如果 DeepSeek 返回 4xx/5xx 或超时，返回 503
        error_page 400 401 403 404 405 406 407 408 409 410 
                   411 412 413 414 415 416 417 418 421 422 
                   423 424 425 426 428 429 431 451 
                   500 501 502 503 504 505 506 507 508 510 511 
                   =503 @ds_down;
        
        # 默认也返回 503
        return 503;
    }
    
    location @ds_ok {
        add_header Content-Type text/plain;
        return 200 "DeepSeek Service: OK\n";
    }
    
    location @ds_down {
        add_header Content-Type text/plain;
        return 503 "DeepSeek Service: Down\n";
    }
    
    # 1. Nginx 状态
    location /nginx_status {
        stub_status;
        access_log off;
        allow all;
    }
    
    # 2. Edge TTS -> 5050
    location ^~ /v1/audio {
        proxy_pass http://127.0.0.1:5050;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        chunked_transfer_encoding on;
    }
    
    # 3. Deepseek -> 5001
    location /ds/ {
        rewrite ^/ds/(.*) /$1 break;
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Connection "";
        proxy_http_version 1.1;
    }
    
    # 4. QwenChat2Api -> 8000
    location /qw/ {
        rewrite ^/qw/(.*) /$1 break;
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
    
    # 5. Worker 代理服务 -> 3002
    location /worker/ {
        rewrite ^/worker/(.*) /$1 break;
        proxy_pass http://127.0.0.1:3002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;
        proxy_set_header Accept-Encoding "";
    }
    
    # 6. 根目录 -> Qwen2API
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}

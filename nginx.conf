[file content begin]
server {
    # 监听 Koyeb 的入口端口
    listen 8080 default_server;
    
    # 1. Nginx 状态 - 增加健康检查
    location /nginx_status {
        # 先执行内部重写到健康检查
        set $backend_check "";
        
        # 检查 deepseek 服务是否正常（使用 HEAD 方法减少资源占用）
        rewrite_by_lua_block {
            local http = require "resty.http"
            local httpc = http.new()
            
            -- 设置较短的超时时间，避免阻塞太久
            httpc:set_timeout(3000) -- 3秒超时
            
            local res, err = httpc:request_uri("http://127.0.0.1:5001/v1", {
                method = "HEAD",
                headers = {
                    ["Content-Type"] = "application/json",
                    ["Accept"] = "application/json"
                }
            })
            
            if not res then
                ngx.log(ngx.ERR, "DeepSeek health check failed: ", err)
                ngx.var.backend_check = "failed"
            elseif res.status ~= 200 and res.status ~= 401 and res.status ~= 404 then
                -- 200: 服务正常, 401: 需要认证但服务存在, 404: 端点存在但路径不对
                -- 这些状态都表示服务在运行
                ngx.log(ngx.ERR, "DeepSeek returned status: ", res.status)
                ngx.var.backend_check = "failed"
            else
                ngx.var.backend_check = "passed"
            end
        }
        
        # 如果健康检查失败，返回 503 服务不可用
        if ($backend_check = "failed") {
            return 503 "Service Unavailable: DeepSeek backend is not responding";
        }
        
        # 健康检查通过，返回 nginx 状态
        stub_status;
        access_log off;
        allow all;
    }
    
    # 2. Edge TTS -> 5050
    location ^~ /v1/audio {
        proxy_pass http://127.0.0.1:5050;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        chunked_transfer_encoding on;
    }
    
    # 3. Deepseek -> 5001
    location /ds/ {
        rewrite ^/ds/(.*) /$1 break;
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Connection "";
        proxy_http_version 1.1;
    }
    
    # 4. QwenChat2Api -> 8000
    location /qw/ {
        rewrite ^/qw/(.*) /$1 break;
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
    
    # 5. Worker 代理服务 -> 3002
    location /worker/ {
        rewrite ^/worker/(.*) /$1 break;
        proxy_pass http://127.0.0.1:3002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;
        proxy_set_header Accept-Encoding "";
    }
    
    # 6. 根目录 -> Qwen2API
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
[file content end]

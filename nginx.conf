server {
    # 监听 Koyeb 的入口端口
    listen 8080 default_server;
    
    # 1. Nginx 状态（带 DeepSeek 健康检查）
    location /nginx_status {
        # 如果这是健康检查请求本身（带特定参数），则跳过检查
        if ($arg_skip_check) {
            stub_status;
            access_log off;
            allow all;
            break;
        }
        
        # 尝试访问 DeepSeek 服务
        set $deepseek_status "Up";
        location /nginx_status/deepseek_check {
            internal;
            proxy_pass http://127.0.0.1:5001/v1;
            proxy_method HEAD;
            proxy_set_header Host $host;
            proxy_connect_timeout 2s;
            proxy_read_timeout 2s;
            proxy_send_timeout 2s;
            proxy_ignore_headers "Set-Cookie" "X-DeepSeek-Status";
        }
        
        # 如果 DeepSeek 不可用，标记状态但不阻断
        error_page 500 502 503 504 = @deepseek_ok;
        proxy_intercept_errors on;
        
        # 发送 HEAD 请求检查 DeepSeek
        rewrite ^ /nginx_status/deepseek_check last;
        
        location @deepseek_ok {
            set $deepseek_status "Down";
            stub_status;
            access_log off;
            allow all;
        }
        
        # 正常情况显示状态
        stub_status;
        access_log off;
        allow all;
    }
    
    # 2. Edge TTS -> 5050
    location ^~ /v1/audio {
        proxy_pass http://127.0.0.1:5050;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        chunked_transfer_encoding on;
    }
    
    # 3. Deepseek -> 5001
    location /ds/ {
        rewrite ^/ds/(.*) /$1 break;
        proxy_pass http://127.0.0.1:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Connection "";
        proxy_http_version 1.1;
    }
    
    # 4. QwenChat2Api -> 8000
    location /qw/ {
        rewrite ^/qw/(.*) /$1 break;
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
    
    # 5. Worker 代理服务 -> 3002
    # 格式：/worker/https://目标地址 或 /worker/http://内部服务地址
    location /worker/ {
        # 去掉 URL 前面的 /worker/
        rewrite ^/worker/(.*) /$1 break;
        
        # 确保代理到正确的端口和地址
        proxy_pass http://127.0.0.1:3002;
        
        # 重要：保留所有原始头部
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 禁用缓冲，允许流式传输
        proxy_buffering off;
        proxy_cache off;
        
        # 启用 chunked 传输编码
        chunked_transfer_encoding on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # 设置超时
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;
        
        # 禁用压缩，避免影响流式传输
        proxy_set_header Accept-Encoding "";
    }
    
    # 6. 根目录 -> Qwen2API
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
